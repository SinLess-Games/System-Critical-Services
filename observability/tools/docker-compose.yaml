networks:
  backend:
    external: true

services:
  ## Tools
  promtail:
    image: grafana/promtail:2.9.5
    restart: unless-stopped
    container_name: promtail
    networks:
      - backend
    volumes:
      - /var/log:/var/log
      - ./configs/promtail.yaml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml

  otelcol:
    image: otel/opentelemetry-collector:0.104.0
    restart: unless-stopped
    container_name: otelcol
    # restart: unless-stopped
    networks:
      - backend
    ports:
      - 4317:4317  # otlp grpc
      - 4318:4318  # otlp http
      - 8888:8888 # monitoring
      - 14268:14268 # jaeger thrift
    command: --config=/etc/otelcol/config.yaml
    volumes:
      - ./configs/otelcol.yaml:/etc/otelcol/config.yaml
    
  goblog:
    image: mariomac/goblog:dev
    restart: unless-stopped
    networks:
      - backend
    ports:
      # Exposes port 18843, forwarding it to container port 8443
      - "18443:8443"

  autoinstrumenter:
    image: grafana/beyla:latest
    pid: "service:goblog"
    restart: unless-stopped
    privileged: true
    ports:
      - 18444:8444
    networks:
      - backend
    environment:
      BEYLA_TRACE_PRINTER: text
      BEYLA_OPEN_PORT: 8443